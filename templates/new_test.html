{% extends "base.html" %}
{% block title %} New Exam {% endblock %}
{%  block content %}
    

<script type="text/javascript">
// Please don't judge this code
//  - Caden	
    
let total_questions = 0;
$(function(){
$("#newExam").submit(function(event) {
        event.preventDefault();
    var v = $("#newExam").validate();
    if(v.valid()) {
    let total_points = $("#ExamPoints").val();
    let total_options = $('.answerText').length;
    if(!total_points || !total_points > 0){
        $.alert({
            title: "Error",
            type: "red",
            content: "Please add at least one question"
        });
        return false;
   	 }
        if(!total_options > 0){
          $.alert({
            title: "Error",
            type: "red",
            content: "Please add at least one option"
        });
        return false;
    }
    let form = {};
    // Create the form manually because jesus hates me
    form.examName = $('#examName').val();
    form.totalPoints = parseInt($('#ExamPoints').val(),10);
    form["questions"] = {};  
    $('.question').each(function(i, obj) {
      let currentQuestion = "question" + (i+1);
   	  form["questions"][currentQuestion] = {};
	$(this).find('.questionName').each(function(j) { 
      form["questions"][currentQuestion].title = $(this).val();
	});
	$(this).find('.questionPoints').each(function(j) { 
      form["questions"][currentQuestion].points = parseInt($(this).val(),10);
	});
     form["questions"][currentQuestion]["answers"] = {};
        $(this).find('.answerGroup').each(function(j){
            let currentAnswer = "answer" + (j+1);
            form["questions"][currentQuestion]["answers"][currentAnswer] = {};
			$(this).find('#correctAnswer').each(function(k){
			form["questions"][currentQuestion]["answers"][currentAnswer].answerText = $(this).val();
            });
            $(this).find('.correctAnswer').each(function(k){
             form["questions"][currentQuestion]["answers"][currentAnswer].correct = $(this).is(":checked");
            });
        });
    });
    $.ajaxSetup({
    beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", Cookies.get('csrftoken'));
        }
	});  
    $.ajax({
       type: "POST",
       contentType: "application/json; charset=utf-8",
       dataType: "json",
       url: "/postNewExam/",
       data: JSON.stringify(form),
       success: function(data) {
           		$.confirm({
                    title: "Exam Created!",
                    content: "Create another or go to the home page?",
                    buttons: {
                        another: {
                        	text: "Another one!",
                            btnClass: "btn-primary",
                        	action: function() {
								window.location="/new_test";                 
                        	}
                        },
                        home: {
                        	text: "Go Home.",
                        	btnClass: "btn-primary",
                        	action: function() {
                        	window.location="/";
                        }
                        }
                    }
                })
    		},
        error: function(error) {
        	console.log(error);
        }
    });
    } else {
    }
});
    return false;
    });
    
    
function updateTotalPoints() {
    let sum = 0;
    $('.questionPoints').each(function(i, obj) {
        if($(this).val()){
          sum += parseInt($(this).val(),10);
        }
	});
    $("#ExamPoints").val(sum);
}    

function addQuestion() {
    let questionNumber = ++total_questions;
    $(".questionContainer").append(
        `
    <div class="question `+questionNumber+`" >
<button onclick="return removeQuestion('.questionContainer .question.`+questionNumber+`')" class='btn btn-primary' style='float:right'>Remove Question</button>

<h2 class="questionTitle `+questionNumber+`"> Quesiton `+questionNumber+`</h2>
<!-- Prepended text-->
<div class="form-group">
  <label class="col-md-12 control-label" for="Question`+questionNumber+`"></label>
  <div class="col-md-12">
    <div class="input-group">
      <span class="input-group-addon">Question Title</span>
      <input id="Question`+questionNumber+`" name="Question`+questionNumber+`" class="form-control questionName `+questionNumber+`" placeholder="Question Title" type="text" required>
    </div>
  </div>
</div>

<div class="form-group">
  <label class="col-md-12 control-label" for="QuestionPoints `+questionNumber+`"></label>
  <div class="col-md-12">
    <div class="input-group">
      <span class="input-group-addon">Question Points</span>
      <input id="QuestionPoints`+questionNumber+`" name="QuestionPoints `+questionNumber+`" class="form-control questionPoints" placeholder="ex: 100" type="number" required>
    </div>
  </div>
</div>

<!-- Prepended checkbox -->
<div class="form-group options`+questionNumber+`">
        <button class="btn btn-primary" onclick="return addOption('`+questionNumber+`')">
        Add Option
    </button>
<br/>
</div>
    </div>
	`);    
    
$(".questionPoints").on('keyup change click', function() {
    updateTotalPoints();
	});
    
$(function(){
  $('#Question'+questionNumber).change(function(){
     $('.questionTitle'+'.'+questionNumber).text($(this).val());
  });
});
    return false;
}
    
function addOption(questionNumber){
    let thisOptionNumber = $(".options" + questionNumber + " .correctAnswer").length + 1;
    $(".options"+questionNumber).append(`
  <div class="col-md-12 option ` +  thisOptionNumber + `">
<br/>
    <div class="input-group answerGroup">
      <span class="input-group-addon">     
          <input class="correctAnswer ` + thisOptionNumber+ `" type="checkbox">     
      </span>
      <input id="correctAnswer" name="correctAnswer" class="answerText form-control col-md-11" type="text" placeholder="Option Text" required>
<button onclick="return removeOption('.options`+questionNumber+` .option.`+thisOptionNumber+`')" class='btn btn-primary col-md-1 removeOption'>X</button>
    </div>

  </div>`);
    return false;
}
    
    function removeQuestion(questionToRemove){
        --total_questions;
        $(questionToRemove).remove();
        return false;
    }
    
function removeOption(optionToRemove) {
    $(optionToRemove).remove();
    return false;
}
    
    
</script>
<div class="col-md-12">

<form id="newExam" class="form-horizontal card" method="POST">
<fieldset>
     {% csrf_token %}
 <div class="card-header newExamHead">
        Create New Exam
  </div>
<!-- Prepended text-->
<div class="form-group">
  <label class="col-md-12 control-label" for="examName"></label>
  <div class="col-md-12">
    <div class="input-group">
      <span class="input-group-addon">Exam Name</span>
      <input id="examName" name="examName" class="form-control" placeholder="Exam Name" type="text" required>
    </div>
    
  </div>
</div>
<div class="form-group">
  <label class="col-md-12 control-label" for="ExamPoints"></label>
  <div class="col-md-12">
    <div class="input-group">
      <span class="input-group-addon">Exam Points</span>
      <input id="ExamPoints" name="ExamPoints" class="form-control" placeholder="Will Be Calculated" type="number" disabled>
    </div>
  </div>
</div>
    <hr/>
     <div class="questionContainer col-md-12">
    </div>
    <div class="form-group">
  <div class="  col-md-12" align="center">
    <button class="btn btn-primary" onclick="return addQuestion()">Add Question</button>
    <hr/>
        </div></div>
<div class="form-group">
  <div class="col-md-12" align="center">
        <button type="submit" class="btn btn-secondary">
    Create Exam
    </button>
            </div>
  </div>

</fieldset>
</form>
    
</div>

{% endblock %}